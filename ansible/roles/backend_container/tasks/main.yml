---
- name: Ensure app directory exists
  file:
    path: /opt/flask_backend
    state: directory
    owner: devops
    group: devops
    mode: '0755'

- name: Copy Flask app files
  copy:
    src: app/
    dest: /opt/flask_backend/app/
    owner: devops
    group: devops
    mode: '0755'

- name: Copy Dockerfile
  copy:
    src: Dockerfile
    dest: /opt/flask_backend/Dockerfile

- name: Ensure Docker is installed
  apt:
    name:
      - docker.io
      - python3-pip
    state: present
    update_cache: yes

- name: Install Docker Python SDK
  pip:
    name: docker
    state: present

- name: Ensure Docker service is running
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Build backend Docker image
  community.docker.docker_image:
    name: flask-backend
    tag: latest
    build:
      path: /opt/flask_backend
    source: build
    force_source: true

- name: Stop any running backend container
  docker_container:
    name: flask_backend
    state: absent
  ignore_errors: yes

- name: Run backend container
  docker_container:
    name: flask_backend
    image: flask-backend:latest
    restart_policy: always
    state: started
    ports:
      - "5000:5000"
    env:
      ROLE: "backend"
      HOST_VM: "{{ ansible_hostname }}"

- name: Verify backend container is running
  shell: docker ps --filter "name=flask_backend" --format "{{'{{.Names}}'}}"
  register: backend_status
  changed_when: false

- name: Display backend container status
  debug:
    msg: "Backend container is running on {{ ansible_hostname }}: {{ backend_status.stdout }}"
